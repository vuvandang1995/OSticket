<!DOCTYPE html>
<html lang="en">
<head>
    {% load staticfiles %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{% static 'css/header.css' %}" type="text/css">
	<link rel="stylesheet" href="{% static 'timeline/css/style.css' %}"> <!-- Resource style -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <title>{{ user.fullname }}</title>
</head>
<body>
<div class="header">
    <nav class="main-menu">
        <ul>
            <li><a class="list-group-item" href=""><i class="fa fa-bell" aria-hidden="true"></i>&nbsp;  <span id="noti" class="badge badge-light noti"></span></a></li>
            <li><a class="list-group-item" href="{% url 'user:homeuser' %}"><i class="fa fa-home fa-fw" aria-hidden="true"></i>&nbsp; Home</a></li>
            <li><a class="list-group-item" href="{% url 'user:detail_user' %}"><i class="fa fa-cog fa-fw" aria-hidden="true"></i>&nbsp; Settings</a></li>
            <li><a class="list-group-item" href="{% url 'user:logout' %}"><i class="fa fa-sign-out" aria-hidden="true"></i>&nbsp; Logout</a></li>
        </ul>
    </nav>
</div>
<br/>
<br/>
<div class="container" id="info_user">
    <h2>Your tickets</h2>
    <br/>
    <button class="btn btn-lg btn-primary" data-toggle="modal" data-target="#id02">
        <span class="glyphicon glyphicon-plus"></span> Create new ticket
    </button>
    <br/>
    <br/>
    <table class="table table-striped table-bordered" id="info_user">
        <tr>
            <td>ID</td>
            <td>Title</td>
            <td>Status</td>
            <td>Handler</td>
            <td>Option</td>
        </tr>
        {% for tk in ticket %}
        <tr>
            <td>
                <button type="button" class="btn" data-toggle="modal" data-target="#{{tk.id}}content">{{tk.id}}</button>
            </td>
            <td>{{tk.title}}</td>
            {% if tk.status == 0 %}
            <td><span class="label label-danger">pending</span></td>
            {% elif tk.status == 1 %}
            <td><span class="label label-warning">processing</span></td>
            {% elif tk.status == 2 %}
            <td><span class="label label-success">done</span></td>
            {% else %}
            <td><span class="label label-default">closed</span></td>
            {% endif %}


            {% if tk.status == 0 %}
                <td id="hd{{tk.id}}">Nobody</td>
            {% else %}
                <td id="hd{{tk.id}}">
                    {% for hd in handler %}
                        {% if hd.ticketid == tk %}
                            {{hd.agentid.username}}<br>
                        {% endif%}
                    {% endfor%}
                </td>
            {% endif %}

            <td>
            {% if tk.status < 3 %}
                <a href="{% url 'user:close_ticket' tk.id %}" type="button" class="btn btn-danger close_ticket" data-toggle="tooltip" title="close" id="{{tk.id}}">
                    <span class="glyphicon glyphicon-off"></span>
                </a>
            {% else %}
                <a href="{% url 'user:close_ticket' tk.id %}" disabled type="button" class="btn btn-danger" data-toggle="tooltip" title="close">
                    <span class="glyphicon glyphicon-off"></span>
                </a>
            {% endif %}
            {% if 0 < tk.status and tk.status < 3 %}
                <a href="{% url 'user:conversation' tk.id %}" type="button" class="btn btn-primary" data-toggle="tooltip" title="conversation">
                    <span class="glyphicon glyphicon-comment"></span>
                </a>
            {% else %}
                <a href="{% url 'user:conversation' tk.id %}" disabled type="button" class="btn btn-primary" data-toggle="tooltip" title="conversation">
                    <span class="glyphicon glyphicon-comment"></span>
                </a>
            {% endif %}
                <a href="{% url 'user:history' tk.id %}" type="button" class="btn btn-warning" data-toggle="tooltip" title="history">
                    <span class="glyphicon glyphicon-floppy-disk"></span>
                </a>
            </td>
        </tr>

        

        <div class="modal fade" id="{{tk.id}}content" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                        <h4 class="modal-title">Ticket no.{{tk.id}}</h4>
                    </div>
                    <div class="modal-body form-group">
                        <label for="content">Title:</label>
                        <p><b>{{tk.title}}</b></p><br>
                        <label for="content">Topic:</label>
                        <p><b>{{tk.topicid.name}}</b></p><br>
                        <label for="content">Content:</label>
                        <p><b>{{tk.content}}</b></p><br>
                        <label for="datestart">Date Start:</label>
                        <p><b>{{ tk.datestart}}</b></p><br>
                        <label for="dateend">Date End:</label>
                        <p><b>{{tk.dateend}}</b></p>
                        <br/>
                        {% if tk.attach != '' %}
                        <label for="dateend">Attach:</label>
                        <img src="/media/{{tk.attach}}" alt="none" style="width:100%;height:100%;">
                        {% endif %}
                    </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </table>

</div>
<script>
        $(document).ready(function(){
            $("#info_user").on('click', '.close_ticket', function(){
                var id = $(this).attr('id');
                var message = 'close_ticket';
                var Sockets = [];
                if(confirm("Are you sure ?")){
                    var array = $('#hd'+id).html().split("<br>");
                    for (i = 0; i < array.length-1; i++) {
                        var agentName = array[i].replace(/\s/g,'');
                        
                        var Socket1 = new WebSocket(
                        'ws://' + window.location.host +
                        '/ws/agent/' + agentName + '/');
    
                        Sockets.push(Socket1);
    
                        Socket1.onopen = function (event) {
                            setTimeout(function(){
                                Socket1.send(JSON.stringify({
                                    'message' : message,
                                }));
                            }, 1000);
                        };
                        
                    }
                    /*setTimeout(function(){
                        for(s in Sockets){
                            Sockets[s].close();
                        }
                    }, 3000);*/
                    setTimeout(function(){
                        location.href="/user/close_"+id;
                    }, 2000);
                    
                }
                
            });
            
    
            $("#info_user").on('click', '.conversation_user', function(){
                var id = $(this).attr('id');
                location.href="/user/"+id;
            });
        });
</script>

<div class="modal fade" id="id02" role="dialog" >
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">New ticket</h4>
            </div>
             <div class="modal-body form-group">
                 <form method="POST" enctype="multipart/form-data" onsubmit="return validateSize()">
                     {% csrf_token %}
                     {% for key, value in form.error.items %}
                     {{value}}
                     {% endfor%}
                     <label for="title"><b>Title</b></label>
                     {{form.title}}
                     <br /><label for="topic"><b>Topic</b></label><br />
                     <select name="topic" class="form-control">
                         {% for tp in topic %}
                         <option value="{{tp.id}}">{{tp.name}}</option>
                         {% endfor %}
                     </select>
                     <br /><br />
                     <label for="content"><b>Content</b></label><br /><br />
                     {{form.content}}
                     <br />
                     <label for="attach"><b>Attach</b></label><br />
                     <input type="file" name="attach" id="attach">
                     <br/>
                     <div><font id="invalid-msg" color="red" size="5"></font></div>
                     <button type="submit" class="btn btn-primary" value="OK" id="i_submit" onsubmit="return validateSize()">Send</button>
                     <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                 </form>
             </div>
        </div>
    </div>
</div>
<script type="text/javascript" >
    $('#invalid-msg').html("");
    function validateSize(){
        if(($("#attach"))[0].files[0].size > 10485760){
            $('#invalid-msg').html("maximum size is 10MB");
            return false;
        }
        return true;
    }

    $(document).ready(function(){
        // sau khi submit thanh cong thi send message tu websocket len server
        $("#id02").submit(function() {
            var chatSocket1 = new WebSocket(
            'ws://' + window.location.host +
            '/ws/agent/group_agent_Socket/');
            var message = 'new_ticket';
            chatSocket1.onopen = function (event) {
                chatSocket1.send(JSON.stringify({
                    'message' : message,
                }));
            };
        });
    });
</script>
<audio id="myAudio" controls="controls" onloadeddata="audioSoundFunction()">
    <source src="{% static 'ping.mp3' %}" type="audio/mpeg">
</audio>

{% comment %} <input value="Click me" id="sound"> {% endcomment %}
</body>

<script>
        var userName = {{ username }};
        var chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/user/' + userName + '/');
        
        
        // nhan message tu server
        chatSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var message = data['message'];
            document.getElementById('noti').innerHTML = message;
            setTimeout(function(){
                $("#info_user").load(location.href + " #info_user");
            }, 2000);
            //document.getElementById('sound').click();
            
            //var snd='<audio autoplay=true> <source src="{% static 'ping.mp3' %}"> </audio>';
            //$('body').append(snd);
        };
    

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
</script>
</html>