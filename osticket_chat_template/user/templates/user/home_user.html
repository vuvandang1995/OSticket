<!DOCTYPE html>
<html lang="en">
<head>
    {% load staticfiles %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{% static 'css/login.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'css/header.css' %}" type="text/css">
	<link rel="stylesheet" href="{% static 'timeline/css/style.css' %}"> <!-- Resource style -->
    <!--<link rel="stylesheet" href="{% static 'css/form.css' %}" type="text/css">-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="{% static 'js/home_admin.js' %}"></script>
    <title>{{ user.fullname }}</title>
</head>
<body>
<div class="header">
        <nav class="main-menu">
				<ul>
                    <li><a href="{% url 'user:homeuser' %}">Home</a></li>
                    <li><a href="{% url 'user:detail_user' %}">Profile</a></li>
                    <li><a href="{% url 'user:logout' %}">Logout</a></li>
				</ul>
		</nav>
    </div>
<div class="container" id="info_user">
    <h2>Your tickets</h2>
    <table class="table table-striped table-bordered">
        <tr>
            <td>ID</td>
            <td>Title</td>
            <td>Status</td>
            <td>Handler</td>
            <td>Close ticket</td>
            <td>Conversation</td>
            <th>History</th>
        </tr>
        {% for tk in ticket %}
        <tr>
            <td>
                <button type="button" class="btn btn-lg" data-toggle="modal" data-target="#{{tk.id}}content">{{tk.id}}</button>
            </td>
            <td>{{tk.title}}</td>
            {% if tk.status == 0 %}
            <td>pending...</td>
            {% elif tk.status == 1 %}
            <td>processing...</td>
            {% elif tk.status == 2 %}
            <td>done</td>
            {% else %}
            <td>closed</td>
            {% endif %}
            <td>{% for tic in atic %}
                {% if tic.ticketid == tk %}
                {{tic.agentid.fullname}},
                {% endif %}
                {% endfor %}
            </td>
            {% if tk.status < 3 %}
            <td>
                <form >
                    <button id="close_{{forloop.counter}}" type="button">close</button>
                </form>
            </td>
            {% else %}
            <td></td>
            {% endif %}
            {% if 0 < tk.status and tk.status < 3 %}
            <td>
                <form >
                    <button id="con_{{forloop.counter}}" type="button">Conversation</button>
                </form>
            </td>
            {% else %}
            <td></td>
            {% endif %}
            <td>
                <button data-toggle="modal" data-target="#timeline{{tk.id}}">History</button>
            </td>
        </tr>
        <script type="text/javascript">
            var btn = document.getElementById("close_{{forloop.counter}}");
            btn.onclick = function(){
                if(confirm("Are you sure ?")){
                    location.href="{% url 'user:close_ticket' tk.id %}"
                }
            };
            var btn2 = document.getElementById("con_{{forloop.counter}}");
            btn2.onclick = function(){
                location.href="{% url 'user:conversation' tk.id %}"
            };
        </script>
        <div class="modal fade" id="{{tk.id}}content" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                        <h4 class="modal-title">Ticket no.{{tk.id}}</h4>
                    </div>
                    <div class="modal-body form-group">
                        <label for="content">Title:</label>
                        <p><b>{{tk.title}}</b></p><br>
                        <label for="content">Topic:</label>
                        <p><b>{{tk.topicid.name}}</b></p><br>
                        <label for="content">Content:</label>
                        <p><b>{{tk.content}}</b></p><br>
                        <label for="datestart">Date Start:</label>
                        <p><b>{{ tk.datestart}}</b></p><br>
                        <label for="dateend">Date End:</label>
                        <p><b>{{tk.dateend}}</b></p>
                        <br/>
                        {% if tk.attach != '' %}
                        <label for="dateend">Attach:</label>
                        <img src="/media/{{tk.attach}}" alt="none" style="width:100%;height:100%;">
                        {% endif %}
                    </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                </div>
            </div>
        </div>
        <div class="modal fade " id="timeline{{tk.id}}" >
            <div class="modal-dialog" style="width:100%;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">History of ticket no.{{tk.id}}</h2>
                    </div>
                    <div class="modal-body form-group" >
                        <div>
                            {% if tk.status == 0 %}
                            <font color="black" size="5">Ticket status :</font><font color="red" size="5"> pending...</font>
                            {% elif tk.status == 1 %}
                            <font color="black" size="5">Ticket status :</font><font color="orange" size="5"> processing...</font>
                            {% elif tk.status == 2 %}
                            <font color="black" size="5">Ticket status :</font><font color="green" size="5"> done</font>
                            {% else %}
                            <font color="black" size="5">Ticket status :</font><font color="blue" size="5"> closed</font>
                            {% endif%}
                            <br/>
                            <br/>
                            {% for key, value in timeticket.items %}
                                {% if key == tk.id %}
                            <font color="black" size="5">Ticket exist time:</font><font color="green" size="5"> {{value}}</font></p>
                                {% endif %}
                            {% endfor %}
                        </div>
                            <div style="display:inline-block;width:100%;overflow-x:scroll;">
                                <ul class="timeline timeline-horizontal">
                                    {% for ht in htic %}
                                    {% if ht.ticketid.id == tk.id %}
                                    <li class="timeline-item">
                                        <div class="timeline-badge success"><i class="glyphicon glyphicon-check"></i></div>
                                        <div class="timeline-panel">
                                            <div class="timeline-heading">
                                                <h2 class="timeline-title">{{ht.action}}</h2>
                                                <p><big class="text-muted"><i class="glyphicon glyphicon-time"></i> {{ht.time}} {{ht.weekday}} </big></p>
                                                <p><big class="text-muted">{{ht.date}}</big></p>
                                            </div>
                                            <div class="timeline-body">
                                                {% if ht.userid is not None %}
                                                <h3 class="timeline-title">by {{ht.userid.fullname}} ( owner )</h3>
                                                {% else %}
                                                <h3 class="timeline-title">by {{ht.agentid.fullname}} ( agent )</h3>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </table>
    <button style="width:auto;" data-toggle="modal" data-target="#id02">Create new ticket</button>
</div>
<div class="modal fade" id="id02" >
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title">New ticket</h4>
        </div>
             <div class="modal-body form-group">
                 <form method="POST" enctype="multipart/form-data" onsubmit="return validateSize()">
                     {% csrf_token %}
                     {% for key, value in form.error.items %}
                     {{value}}
                     {% endfor%}
                     <label for="title"><b>Title</b></label>
                     {{form.title}}
                     <label for="topic"><b>Topic</b></label><br />
                     <select name="topic" >
                         {% for tp in topic %}
                         <option value="{{tp.id}}">{{tp.name}}</option>
                         {% endfor %}
                     </select>
                     <br /><br />
                     <label for="content"><b>Content</b></label><br /><br />
                     {{form.content}}
                     <br /><br />
                     <label for="attach"><b>Attach</b></label><br />
                     <input type="file" name="attach" id="attach">
                     <br/>
                     <div><font id="invalid-msg" color="red" size="5"></font></div>
                     <br /><br />
                     <button type="submit" value="OK" id="i_submit">Send</button>
                 </form>
             </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
        <script type="text/javascript" >
            $('#invalid-msg').html("");
            function validateSize(){
                if(($("#attach"))[0].files[0].size > 10485760){
                    $('#invalid-msg').html("maximum size is 10MB");
                    return false;
                }
                return true;
            }
        </script>
    </div>
</div>
</body>
</html>