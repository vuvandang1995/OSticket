{% extends 'agent/base.html' %}
{% block lib %}
{% endblock%}
{% block title %}Agent{% endblock %}
{% block content %}
    <div id="list_ticket">
            <h2>Hi {{agent.fullname}}({{agent.id}})</h2>
            <h2>Open tickets</h2>
            <table class="table table-striped table-bordered" >
                <tr>
                    <td>ID</td>
                    <td>Title</td>
                    <td>Date expired</td>
                    <td>Status</td>
                    <td>Assign</td>
                </tr>
                {% for tk in ticket %}
                <tr>
                    <td>
                        <button type="button" class="btn btn-lg" data-toggle="modal" data-target="#{{tk.id}}content">{{tk.id}}</button>
                    </td>
                    <td>{{tk.title}}</td>
                    <td>{{tk.dateend}}</td>
                    <td>pending...</td>
                    <td>
                        <form method="post" id="assignform">
                            <button id="{{tk.id}}" type="button" class="assign_ticket">Assign</button>
                        </form>
                    </td>
                </tr>
                <div class="modal fade" id="{{tk.id}}content" role="dialog">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal">&times;</button>
                          <h4 class="modal-title">Chi tiáº¿t</h4>
                        </div>
                        <div class="modal-body form-group">
                            <label for="content">Content:</label>
                            <p><b>{{tk.content}}</b></p><br>
                            <label for="datestart">Date Start:</label>
                            <p><b>{{ tk.datestart}}</b></p><br>
                            <label for="dateend">Date End:</label>
                            <p><b>{{tk.dateend}}</b></p>
                            {% if tk.attach != '' %}
                             <label for="dateend">Attach:</label>
                            <img src="/media/{{tk.attach}}" alt="none" style="width:100%;height:100%;">
                            {% endif %}
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                <input id="user_name" type="hidden" value="{{ tk.sender.username}}">
                <input id="agent_name" type="hidden" value="{{ agent.username}}">
                
                {% endfor%}
            </table>
        </div>
        <script>
            $(document).ready(function(){
                $("#list_ticket").on('click', '.assign_ticket', function(){
                    var id = $(this).attr('id');
                    if(confirm("Are you sure ?")){
                        var userName = document.getElementById('user_name').value;
                        var chatSocket1 = new WebSocket(
                            'ws://' + window.location.host +
                            '/ws/user/' + userName + '/');

                        message = 'ticket '+id+' dang duoc xu ly';
                        chatSocket1.onopen = function (event) {
                            chatSocket1.send(JSON.stringify({
                                'message' : message,
                            }));
                        };
                        location.href="/agent/assign/"+id;
                    }
                });
            });
        </script>
{% endblock %}